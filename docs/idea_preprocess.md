# Overview

- データの前処理手法について検討する
- 特徴量エンジニアリングには、ラグ特徴量、移動平均特徴量、MSTL分解を用いる

| method | description | role |
|--------|-------------| ------------------|
| ラグ特徴量 | 過去の値を特徴量として追加 | 時系列データの自己相関を捉える<br>1ヶ月以内の遅れを考慮 |
| 移動平均特徴量 | 過去の一定期間の平均値を特徴量として追加 | 短期的な変動を平滑化し、トレンドを捉える<br>短期的なノイズ除去 |
| MSTL分解 | 時系列データをトレンド、季節性、残差に分解し、各成分を特徴量として追加 | 長期的なトレンドと季節性を捉える<br>複数の季節性を考慮 |

# Steps

## 1. 基本的な前処理

- データの読み込み
- 日時型への変換
- 欠損値の確認と対処
- 異常値の検出と対処
    - 外れ値: IQR法、Zスコア法など
    - 変化がない値(例: 連続する同一値)の確認
- 重複レコードの確認と削除
- データの分割
    - 訓練データ: 2016-07-01 00:00:00 〜 2018-02-01 13:59:59
    - テストデータ: 2018-02-01 14:00:00 〜 2018-06-26 19:00:00

## 2. MSTL分解の適用
- MSTL分解を用いて、全パラメータをトレンド(trend)、季節性(seasonal)、残差(resid)に分解
- 各成分を新たな特徴量として追加
- 季節性の周期は以下を考慮

### テストデータへの適用方法
- トレンド成分:
    - Level1: 線形外挿法を用いてテストデータに適用
    - Level2: n次の整式回帰モデルをトレーニングデータのトレンド成分にフィットさせ、テストデータに外挿
    - Level3: トレンド成分を$T=a_{0}+a_{1}t+a_{2}t^{2}+a_{3}t^{3}+a_{4}sin(2\pi t)$と仮定し、トレーニングデータのトレンド成分に対して最小二乗法で係数を推定。推定されたモデルを用いてテストデータに外挿
- 季節性成分:
    - Level1: トレーニングデータの最後の周期からマッピング
- 残差成分:
    - Level1: テストデータには0を適用
    - Level2: トレーニングデータの残渣成分からARIMAモデルを構築し、予測値を適用(ACFの確認が必要)

## 3. ラグ特徴量の作成
- 各特徴量に対して、過去の値をラグ特徴量として追加
- ラグ期間は1, 3, 6時間を考慮

## 4. 移動平均特徴量の作成
- 各特徴量に対して、過去の一定期間の平均値を移動平均特徴量として追加
- 移動平均のウィンドウサイズは3, 6, 12時間を考慮

## 5. 正規化・標準化

- 成分ごとに、個別で正規化を行う
- `StandardScaler`を用いて、平均0、標準偏差1に変換

## 6. データの保存
- 前処理後のデータをParquet形式で保存
- 保存先は`config/config.yml`の`data.experiment`で指定されたフォルダ`exp_<nnn>`を使用
- ファイル名は`<test,train>_<h1,h2>.parquet`の形式で保存 (例: `test_<h1>_001.parquet`)
